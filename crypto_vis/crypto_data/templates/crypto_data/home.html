{% extends 'base.html' %}
{% block content %}
    <h1>Crypto Visualizer</h1>

    <h2>Top 100 Cryptocurrencies</h2>
    <ul>
        {% for coin in crypto_data %}
            <li>{{ coin.name }}: ${{ coin.current_price }}</li>
        {% endfor %}
    </ul>

    <h2>Top 10 Price Comparison Chart</h2>
    <div class="chart-container">
        <canvas id="priceBarChart"></canvas>
    </div>

    <h2>7-Day Price Trend</h2>
    <div class="chart-container">
        <canvas id="priceTrendChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    {{ bar_labels|json_script:"barLabels" }}
    {{ bar_data|json_script:"barData" }}
    {{ historical_data|json_script:"historicalData" }}
    {{ dates|json_script:"dates" }}
    {{ top_10_ids|json_script:"top10Ids" }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Bar Chart
            const barCtx = document.getElementById('priceBarChart').getContext('2d');
            const barLabels = JSON.parse(document.getElementById('barLabels').textContent);
            const barData = JSON.parse(document.getElementById('barData').textContent);

            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [{
                        label: 'Current Price (USD)',
                        data: barData,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)',
                            'rgba(255, 99, 255, 0.7)', 'rgba(99, 255, 132, 0.7)'
                        ],
                        borderColor: 'rgba(0, 0, 0, 0.8)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Price (USD)', font: { size: 14 } },
                            ticks: { callback: value => `$${value.toLocaleString()}` },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        x: { title: { display: true, text: 'Cryptocurrency', font: { size: 14 } } }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: $${ctx.raw.toLocaleString()}` } },
                        datalabels: { display: false }
                    }
                }
            });

            // 7-Day Price Trend Chart
            const trendCtx = document.getElementById('priceTrendChart').getContext('2d');
            const historicalData = JSON.parse(document.getElementById('historicalData').textContent);
            const dates = JSON.parse(document.getElementById('dates').textContent);
            const top10Ids = JSON.parse(document.getElementById('top10Ids').textContent);

            const colors = [
                'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(199, 199, 199, 1)', 'rgba(83, 102, 255, 1)',
                'rgba(255, 99, 255, 1)', 'rgba(99, 255, 132, 1)'
            ];

            const datasets = top10Ids.map((id, index) => {
                const isBitcoin = id === 'bitcoin';
                return {
                    label: id.charAt(0).toUpperCase() + id.slice(1),
                    data: historicalData[id],
                    borderColor: colors[index % colors.length],
                    yAxisID: isBitcoin ? 'y-right' : 'y-left',
                    borderWidth: 2,
                    fill: false
                };
            });

            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Date', font: { size: 14 } } },
                        'y-left': {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Price (USD) - Others', font: { size: 14 } },
                            ticks: { callback: value => `$${value.toLocaleString()}` },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            max: Math.max(...datasets.filter(ds => ds.yAxisID === 'y-left').flatMap(ds => ds.data)) * 1.1
                        },
                        'y-right': {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Price (USD) - Bitcoin', font: { size: 14 } },
                            ticks: { callback: value => `$${value.toLocaleString()}` },
                            grid: { drawOnChartArea: false },
                            min: Math.min(...datasets.find(ds => ds.label === 'Bitcoin').data) * 0.9,
                            max: Math.max(...datasets.find(ds => ds.label === 'Bitcoin').data) * 1.1
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: $${ctx.raw.toLocaleString()}` } }
                    }
                }
            });
        });
    </script>
{% endblock %}